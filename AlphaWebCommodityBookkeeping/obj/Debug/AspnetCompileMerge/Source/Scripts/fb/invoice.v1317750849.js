var Fresh=Fresh||{};Fresh.ui={};Fresh.ui.Widget=Class.extend({name:"widget",init:function(c){var e=this;this.visible=c.visible||true;this.element=c.element;this.childWidgets=c.childWidgets||[];this.saveEndpoint=c.saveEndpoint||"/ajax/"+this.name+"/save";this.loadEndpoint=c.loadEndpoint||"/ajax/"+this.name+"/load";this.autoLoad=c.autoLoad||false;this.mapper=c.mapper;this.identifier=c.identifier||this.name;this.saving=false;for(var b in this){if(typeof(this[b])=="function"&&b.charAt(0)!="_"){var a=this._methodNameToEventName(b);var d=function(){e._trigger(arguments.callee.eventName);return arguments.callee.method.apply(e,arguments)};d.method=this[b];d.eventName=a;this[b]=d}}if(this.autoLoad){this.load()}},saveSuccess:function(a){this.saving=false;this.mapper.updateDefaults()},saveError:function(a){this.saving=false},loadSuccess:function(a){this.mapper.set(a)},loadError:function(){},hide:function(){this.element.hide();for(var a=0,b;(b=this.childWidgets[a])!=null;a++){b.hide()}},show:function(){this.element.show();for(var a=0,b;(b=this.childWidgets[a])!=null;a++){b.show()}},reset:function(){this.mapper.clear()},cancel:function(){this.mapper.clear();this.hide()},save:function(){var a=this;this.saving=true;this._performAction("POST",this.saveEndpoint,this.mapper.post(),function(b){a.saveSuccess(b);a._trigger("afterSave")},function(b){a.saveError(b);a._trigger("onSaveError")})},load:function(){var a=this;this._performAction("GET",this.loadEndpoint,{},function(b){a.loadSuccess(b);a._trigger("afterLoad")},function(){a.loadError();a._trigger("onLoadError")})},_performAction:function(c,e,d,a,b){$.ajax({url:e,dataType:"json",data:d,type:c,success:function(f){a(f)},error:function(f){b(f)}})},_trigger:function(a){this.element.trigger(a,[this])},_methodNameToEventName:function(b){var a=b.substring(1);return"on"+b.charAt(0).toUpperCase()+a}});Fresh.ui=Fresh.ui||{};Fresh.ui.FieldMapper=Class.extend({options:{fields:{},parent:null},init:function(a){this.data={};this._fields={};this.parentNode=null;this._defaultValues={};this.options=a=jQuery.extend({},this.options,a);if(this.options.parent){this.parentNode=$(this.options.parent)}this._setFields(a.fields)},_setFields:function(b){var c;for(var a in b){if(this.parentNode){c=this.parentNode.find(b[a])}else{c=$(b[a])}this._fields[a]=c}this.updateDefaults()},getFields:function(){return this._fields},field:function(a){if(a===undefined){return this._fields}if(this._fields[a]!==undefined){return this._fields[a]}},readField:function(a){if(a in this._fields){return this._fields[a].val()}},read:function(){var b;for(b in this._fields){var f=this._fields[b].get(0);var e="";if(f&&(f.type=="radio"||f.type=="checkbox")){var d=$(f.form[f.name]);for(var c=0,a=d.length;c<a;c++){if(d[c].type!="radio"&&d[c].type!="checkbox"){continue}if(d[c].checked){e=d[c].value;break}}}else{if(this._fields[b].length==1){e=this._fields[b].val()}else{e=[];this._fields[b].each(function(g,h){e.push($(h).val())})}}this.data[b]=(e===null||e===undefined)?"":e}return $.extend({},this.data)},post:function(){this.read();var a={},c,b;for(b in this._fields){c=this._fields[b].attr("name");a[c]=this.data[b]}return a},set:function(f){var c,g,h;for(c in f){g=this._fields[c];if(!g){continue}if(g.get(0).type.match(/radio|checkbox/)){var b=jQuery.makeArray(f[c]);h=g.attr("name");var e=$(g.get(0).form[h]);for(var d=0,a=e.length;d<a;d++){if(this.parentNode&&$(e[d]).parents(this.options.parent).length==0){continue}if(jQuery.inArray(e[d].value,b)>-1){e[d].checked=true;break}}}else{g.val(f[c])}}},clear:function(a){this.data={};this._resetFields(a)},_resetFields:function(d){var b,c,a;for(b in this._fields){var c=this._fields[b][0].type,a=this._fields[b][0].tagName.toLowerCase();if(c=="text"||c=="password"||c=="hidden"||a=="textarea"){this._fields[b][0].value=""}else{if(c=="checkbox"||c=="radio"){this._fields[b].attr("checked",false)}else{if(a=="select"){this._fields[b].attr("selectedIndex",-1)}}}}if(d!==false){this.set(this._defaultValues)}},updateDefaults:function(){this._defaultValues=this.read()}});(function(b){function a(c,e){var g=b(c);if(e.saveButton){e.bottom='<div style="float: right"><a name="save" href="#" class="butMedium green"><span>Save</span></a></div>'}if(!e.content){e.content=b(g).html()}var f=b('<div class="content"></div>').html(e.content);var d=b('<div class="bottom"></div>').html(e.bottom);g.html("").addClass("grey-popup-shelf").width(e.width+20+20).append('<div class="top"></div><div class="top-left"></div>').append(f).append(d).append('<div class="bottom-left"></div>');if(e.saveButtonHandler){g.find("a[name=save]").bind("click",e.saveButtonHandler)}if(e.wrapRelativeDiv){g.wrap('<div style="position: relative;" />')}}b.greyPopupShelf={};b.greyPopupShelf.defaults={width:300,saveButton:false,wrapRelativeDiv:true};b.fn.greyPopupShelf=function(c){c=b.extend({},b.greyPopupShelf.defaults,c);this.each(function(){a(this,c)})}})(jQuery);Fresh.EditClientPanel=Class.extend({mode:null,fields:{email:"#client_email",organization:"#client_organization",p_street:"#client_p_street",p_street2:"#client_p_street2",p_city:"#client_p_city",p_code:"#client_p_code",p_country:"#client_p_country",fname:"#client_fname",lname:"#client_lname",vat_number:"#client_vat_number",vat_name:"#client_vat_name"},inputs:{},_backupData:{},oldCustomerId:null,saveButton:null,boxTitle:null,updateClientRecord:null,clientSection:null,buttonText:{create:"Save Client",update:"Update"},titleText:{create:"New Client",update:"Edit Client"},defaults:{customerid:"#customerid",content:"#edit_client_box",clientSection:"#client_section"},init:function(a,d){var b=this;this.options=jQuery.extend({},this.defaults,d||{});this.content=$(this.options.content);this.clientSection=$(this.options.clientSection);$("#client_p_country").change(function(f){changeState($("#client_p_country"),"");showHideVat("client_p_country","vat_info","vat_label","client_vat_number",false,true);$(document).trigger("adaptive.load")}).trigger("change");this.saveClientHandler=function(f){b.save();return false};this.saveButton=$("#save_edit_client");this.boxTitle=$("#edit_client_title");this.saveButton.bind("click",this.saveClientHandler);$("#cancel_edit_client").bind("click",function(f){b.hide();b.restoreData();b.customerId.val(b.oldCustomerId);return false});$("#edit-address").live("click",function(){$("#item-msg").removeClass("error").html("You are updating client details.");$("#update_info").show();b.backupData();b.show("update");return false});for(var c in this.fields){this.inputs[c]=$(this.fields[c])}this.customerId=$(this.options.customerid);this.address=$("#address");this.updateClientRecord=$("#update_client_record");var e=this.customerId.val();if(e&&a){b.setClient(a)}this.oldCustomerId=e;this.inputs.email.bind("change",function(f){if(this.value!=b._backupData.email){b.updateClientRecord.attr({checked:"checked",disabled:"disabled"})}else{b.updateClientRecord.removeAttr("disabled")}})},setClient:function(a){this.inputs.email.val(a.email)},show:function(c){this.mode=c||"create";var b=this.saveButton.data("events");if(!b||!b.click){this.saveButton.bind("click",this.saveClientHandler)}this.content.find("input, select").removeClass("errorInput");var a=this;this.showLoading();if(this.mode=="create"){this.canCreateClient()}else{a.saveOverride();this.inputs.email.focus();$("#update_client_record").removeAttr("disabled");this.showContent()}this.saveButton.find("strong").text(this.buttonText[c]);this.boxTitle.text(this.titleText[c])},canCreateClient:function(){var a=this;$.ajax({url:"/ajax/client/canCreate",dataType:"json",type:"POST",success:function(b){var c=b.canCreateClient;if(c=="1"){$("#update_info").hide();a.clearFields();a.showContent();a.saveOverride();a.inputs.email.focus()}else{alert('Giddy-up cowpoke - your stables are full!\n\nYou\'ve hit your client limit - mosey on over to the "Upgrade" page, or delete some clients so you can manage more.');a.hide();a.customerId.val(a.oldCustomerId).trigger("change")}}})},showLoading:function(){this.clientSection.hide();var a=$('<img src="/images/2ndSite/loading2.gif" style="display: block" class="center" id="edit-client-loading" alt="loading" />');this.clientSection.after(a);this.image=a},showContent:function(){if(this.image){this.image.remove()}this.content.show()},hide:function(){if(this.image){this.image.remove()}this.content.hide();this.undoSaveOverride();this.clientSection.show()},clearFields:function(){$("#edit_client_box").find("input").val("");$("#client_p_country").val("").trigger("change");$("#edit_client_box input[type=text]").removeClass("errorInput");$("#item-msg").removeClass("error").html("You are creating a new client.")},undoSaveOverride:function(){$("input.invoice_action_button").unbind("click",this._onDocumentSave);if(typeof send_by_email_onclick==="function"){$("#send_by_email_button").click(send_by_email_onclick)}},saveOverride:function(){this._onDocumentSave=function(){alert("You must either save or cancel your re-usable client before continuing.");return false};$("input.invoice_action_button").unbind("click");$("input.invoice_action_button").bind("click",this._onDocumentSave)},getProvince:function(){var a=this.content.find("select[name=state_or_province]:enabled").val();if(!a){a=this.content.find("input[name=state_or_province]:enabled").val()}if(a==undefined){a=""}return a},save:function(){var a=this,f=this.mode;$("#edit_client_box input[type=text]").removeClass("errorInput");var c=this.getProvince();var d={};for(var b in this.fields){d[b]=this.inputs[b].val()}d.p_province=c;$("#client_province").val(c);d.organization=this.formatOrganization(d);this.inputs.organization.val(d.organization);var e="";if(f=="update"){if(!$("#update_client_record").is(":checked")){this.formatAddress(d);this.hide();return false}e="/ajax/client/save";d.clientid=this.customerId.val()}else{e="/ajax/client/create"}this.saveButton.unbind("click",this.saveClientHandler);$.ajax({url:e,data:d,type:"POST",dataType:"json",success:function(h){var i=h.clientid;var g=h.organization;if(f=="create"){$option=$('<option value="'+i+'">'+g.htmlentities()+" </option>");a.customerId.prepend($option);a.customerId.val(i).trigger("change")}else{a.formatAddress(d)}a.hide()},error:function(h){var j=JSON.parse(h.responseText);var g=j.error;var i=j.error_field;if(i=="organization"){a.inputs.organization.addClass("errorInput").focus()}else{if(i=="email"){a.inputs.email.addClass("errorInput").focus()}}$("#item-msg").addClass("error").html(g)},complete:function(){a.saveButton.bind("click",a.saveClientHandler)}})},formatOrganization:function(a){var b=a.organization;if(b==""&&(a.fname!=""||a.lname!="")){b=$.trim(a.fname+" "+a.lname)}if(b==""){b=a.email}return b},formatAddress:function(b){var a=this;$.ajax({url:"/ajax/client/formatAddress",data:b,dataType:"json",success:function(c){var d=a.buildAddress(c);a.resizeAddress(d);$("#address").html(d)}})},updateFromResponse:function(b){if(b.p_country!==undefined){this._fixCountry(b.p_country)}for(var c in this.fields){if(!this.inputs[c]){continue}this.inputs[c].val(b[c])}this.inputs.p_country.trigger("change");var a=b.p_province;this.content.find("select[name=state_or_province], input[name=state_or_province]").val(a);$("#client_province").val(a);var d=this.buildAddress(b);this.resizeAddress(d);this.address.html(d);$("#vat_label").text(b.vat_name)},_fixCountry:function(b){var a=this.inputs.p_country.find('option[value="'+b+'"]').length;if(a==0){b=b.htmlentities();this.inputs.p_country.append('<option value="'+b+'">'+b+"</option>")}},buildAddress:function(b){var a=[];jQuery.each(b.address,function(d,e){a.push(e.line.htmlentities())});if(a.length){var c=a.join("<br />");if(b.vat_number&&b.vat_number.length){c+="<br /><strong>"+b.vat_name.htmlentities()+"</strong> "+b.vat_number.htmlentities()}return c}return"<i>No mailing address specified for this client.</i>"},resizeAddress:function(b){var a="auto";if(!b){a="45px"}this.address.css("height",a)},restoreData:function(){for(var b in this.fields){this.inputs[b].val(this._backupData[b])}var a=this._backupData.province;this.content.find("select[name=state_or_province], input[name=state_or_province]").val(a);$("#client_province").val(a);this.inputs.p_country.trigger("change");this.customerId.val(this._backupData.customerid);this.address.html(this._backupData.address)},backupData:function(){this._backupData={};for(var a in this.fields){this._backupData[a]=this.inputs[a].val()}this._backupData.province=this.getProvince();this._backupData.address=$("#address").html();this._backupData.customerid=this.customerId.val()}});Fresh.AdvancedSettings=Class.extend({tag_settings:{remind_tag:"allow_late_notifications",fees_tag:"allow_late_fees",language_tag:"language",currency_tag:"currency_code"},visible_setting:null,init:function(c){var b=this;this.invoice=c;$("#client_tags a").bind("click",function(d){b.show(this);return false});if(c.template=="clean"||c.template=="classic"){$("#client_language").attr("disabled","disabled")}var a=function(){var g={clientid:$("#customerid").val()};$("#customerid").removeAttr("disabled");switch(b.visible_setting){case"language":var f="<span>"+language_lookup[$("#client_language").val()]+"</span>";$("#language_tag").html(f);g.language=$("#client_language").val();if(f!=b.lastLanguage){b.invoice.dirty()}break;case"currency_code":g.currency_code=c.currency.code;if($("#currency_tag").html()!=b.lastCurrency){b.invoice.dirty()}break;case"allow_late_fees":var d=$("#client_late_fees");if(d.length){g.allow_late_fees=Number(d.is(":checked"));$("#fees_tag").html("<span>"+(g.allow_late_fees?"Late Fees":"No Late Fees")+"</span>")}break;case"allow_late_notifications":var e=$("#client_late_notify");if(e.length){g.allow_late_notifications=Number(e.is(":checked"));$("#remind_tag").html("<span>"+(g.allow_late_notifications?"Reminders":"No Reminders")+"</span>")}break;default:return false}$.post("/ajax/client/saveAdvanced",g);$("#client_settings_box").css("display","none");$("#client_tags a").show();b.undoSaveOverride();return false};$("#client_settings_box").greyPopupShelf({width:420,wrapRelativeDiv:true,saveButton:true,saveButtonHandler:a});$("#currency_code").change(function(){var d=$(this).val();c.setCurrencyCode(d)});$("#currency_code").change()},hide:function(){$("#client_settings_box").css("display","none");$("#client_tags a").show()},show:function(a){this.saveOverride();this.lastCurrency=$("#currency_tag").html();this.lastLanguage=$("#language_tag").html();$("#client_tags a").hide();$(".client-setting").hide();$(".client-setting."+a.id).show();$("#client_settings_box").show();$("#customerid").attr("disabled","disabled");this.visible_setting=this.tag_settings[a.id]},undoSaveOverride:function(){$("input.invoice_action_button").unbind("click",this._onDocumentSave);if(typeof send_by_email_onclick==="function"){$("#send_by_email_button").click(send_by_email_onclick)}},saveOverride:function(){this._onDocumentSave=function(){alert("You must update your client settings before continuing.");return false};$("input.invoice_action_button").unbind("click");$("input.invoice_action_button").bind("click",this._onDocumentSave)},setValues:function(a,d,c,b){if(a>""){$("#currency_tag").html("<span>"+a+"</span>")}else{$("#currency_tag").html("<span>none</span>")}$("#language_tag").html("<span>"+d+"</span>");this.setOptions(Number(c),Number(b));$("#client_tags").show()},setOptions:function(b,a){$("#fees_tag").html("<span>"+(b?"Late Fees":"No Late Fees")+"</span>");$("#remind_tag").html("<span>"+(a?"Reminders":"No Reminders")+"</span>")}});Fresh.InvoiceLineBase=Class.extend({blank:function(){var b=this;var a=b.tax1combo.getSelectedValue()!="{}";var f=b.tax2combo.getSelectedValue()!="{}";var c=parseFloat(b.unit_cost.val());var e=parseFloat(b.qty.val());var d=b.description.val();return !(d||a||f||c||e)},_makeComboBoxFromData:function(g,b,e,f,d){var c=g[g.length-1]["value"]=="-1";var a=new dhtmlXCombo(b,e,f);if(c){g[g.length-1].className="combobox-action"}if(d.onAddOption){a.attachEvent("onAddOption",d.onAddOption)}a.addOption(g);a.selectOption(0);if(d.readonly){a.readonly(true)}if(d.onChange){a.attachEvent("onChange",d.onChange)}if(d.onBlur){a.attachEvent("onBlur",d.onBlur)}if(d.listWidth){a.listWidth=d.listWidth}$input=$(b).find("input[type=hidden]:first");$input.data("combobox",a);if(d.klass){$input.addClass(d.klass)}return a},_buildTaxCombos:function(j,d){var i=this;var g=function(k){if(typeof(k)=="undefined"){k=this}if(k.getSelectedValue()=="-1"){k.selectOption(0)}};var h=function(){var m=this.getSelectedValue();var l=this.getSelectedIndex();var k,n;if(m=="-1"){$(document).trigger("invoice.editTaxes");return false}else{if(m!="{}"&&l!=0&&!i.parentTable.disableUpdates){k=$(this.DOMelem_input).closest("tr").find(':input[name="logid_list[]"]').val();if(k&&confirm("Do you wish to apply this tax to all time entries on this invoice?")){i.parentTable.disableUpdates=true;n=$(this.DOMelem_hidden_input).attr("name");$('tr:has(input[name="logid_list[]"][value!=""])').find('input[name="'+n+'"]').each(function(){$(this).data("combobox").setComboValue(m)});i.parentTable.disableUpdates=false}}else{if(m=="{}"&&!i.parentTable.disableUpdates){k=$(this.DOMelem_input).closest("tr").find(':input[name="logid_list[]"]').val();if(k&&confirm("Do you wish to remove the tax from all time entries on this invoice?")){i.parentTable.disableUpdates=true;n=$(this.DOMelem_hidden_input).attr("name");$('tr:has(input[name="logid_list[]"][value!=""])').find('input[name="'+n+'"]').each(function(){$(this).data("combobox").setComboValue(m)});i.parentTable.disableUpdates=false}}}}$(document).trigger("invoice.updateTotal")};var e=function(k,l){return k!==null&&k!==undefined&&l!=="{}"};var b=[];if(e(d.tax1_text,d.tax1)){b.push({value:d.tax1,text:d.tax1_text.htmlentities()})}b=$.merge(b,d.taxes);var a=j.find("div.tax1-container").get(0);i.tax1combo=i._makeComboBoxFromData(b,a,"tax11[]","64px",{readonly:true,onChange:h,klass:"invTax leftTax",onBlur:g,listWidth:140,onAddOption:function(k){if(JSON.parse(k.value).compound){k.disabled=true;k.tooltipText="You cannot use a compound tax in the left tax column."}}});var c=[];if(e(d.tax2_text,d.tax2)){c.push({value:d.tax2,text:d.tax2_text.htmlentities()})}c=$.merge(c,d.taxes);var f=j.find("div.tax2-container").get(0);i.tax2combo=i._makeComboBoxFromData(c,f,"tax22[]","64px",{readonly:true,onChange:h,klass:"invTax",onBlur:g,listWidth:140})},focus:function(){},init:function(c,a){var b=this;b.parentGroup=c;b.parentTable=c.parentTable;b.line=a},disable:function(){var a=this;a.line.find(":input:visible").attr("disabled",true);a.tax1combo.disable(true);a.tax2combo.disable(true)},enable:function(){var a=this;a.line.find(":input:visible").removeAttr("disabled");a.tax1combo.disable(false);a.tax2combo.disable(false)},build:function(c){var b=this;var a=b.line;c.taxes=$.makeArray(b.parentTable.taxOptions);if(b.parentTable.editTaxesOption){c.taxes.push(b.parentTable.editTaxesOption)}b._buildTaxCombos(a,c);b.visibleInputs=a.find("td.editable").find("input[type!=hidden],textarea").focus(function(){$(this).closest("td").addClass("cell-active")}).blur(function(){$(this).closest("td").removeClass("cell-active")});b.unit_cost=a.find('input[name="unit_cost[]"]').keypress(function(d){if(this.id=="time_unit_cost"){return numbersonly(this,d)}return numbersonlynegative(this,d)}).keypress(Fresh.Util.disableFormSubmit);b.qty=a.find('input[name="qty[]"]').keypress(function(d){return numbersonly(this,d)}).keypress(Fresh.Util.disableFormSubmit);b.description=a.find("textarea");return b},show:function(){var a=this;a.line.show();var b=22;a.description.autogrow({width:"252px",fontSize:"12px",fontFamily:"Verdana",maxHeight:b*10,minHeight:b*1,callback:function(c){a.autogrowCallback(c)}})},autogrowCallback:function(a){},setPrice:function(b){var a=this;a.line.find('input[name="price[]"]').val(b);a.line.find("td:last span").html(a.parentTable.currency.format(b))}});Fresh.NewInvoiceItemLine=Fresh.InvoiceLineBase.extend({build:function(b){var a=this;this._super(b);a.line.find('input[name="item_name[]"]').keypress(Fresh.Util.disableFormSubmit);return a},autogrowCallback:function(a){var b=this;var c=b.line.filter("tr.inline-item");c.find("td.inline-item-wrapper-left  span:first").css("margin-top",(a-21)+"px");c.find("td.inline-item-wrapper-right span:first").css("margin-top",(a-21)+"px");c.find("div.holder").css("margin-top",(a+5)+"px")}});Fresh.InvoiceLine=Fresh.InvoiceLineBase.extend({loadItemMap:{},uniqueKeyField:null,build:function(c){var b=this;var a=b.line;this._super(c);this.base_value=b.unit_cost.val();b.visibleInputs.change(function(){b.parentTable.changed=true;if(a[0]==b.parentGroup.container.find("tr:last")[0]){b.parentGroup.addLine(b.parentGroup.BLANK_LINE)}$(document).trigger("invoice.updateTotal");b.base_value=b.unit_cost.val();b.parentTable.dirty()});return b},setType:function(a){this.type=a},disable:function(){var a=this;this._super(args);a.itemCombo.disable(true)},enable:function(){var a=this;this._super(args);a.itemCombo.disable(false)},lookupLineID:function(b){for(var a in item_options){if(item_options[a]==b){return a}}for(var a in task_options){if(task_options[a]==b){return a}}return false},initCombo:function(f,a,e,c,g,d){var h=this;var k=h.line;h.ajax_function=c;h.optionButton=d;h.optionsData=g;a=k.find(a)[0];var j=[{value:f.name,text:html_escape(f.name)}].concat(this.optionsData);j=this.prepareItemOptions(j);if(j[0].value==""){j.shift()}h.itemCombo=h._makeComboBoxFromData(j,a,e,"124px",{readonly:true,onChange:function(){var l=this.getUniqueKey();var n=this.getSelectedValue();if(!n){return}else{if(n=="-1"){h.parentGroup.newPopup(this);return}}var m=$(this.DOMelem).closest("tr");h.loadItem(l,m);this.indexBeforeOnChange=this.getSelectedIndex()},listWidth:195});h.itemCombo.indexBeforeOnChange=h.itemCombo.getSelectedIndex();if(f.taskid){h.itemCombo.setUniqueKey(f.taskid)}else{var i=h.itemCombo.getComboText();var b=h.lookupLineID(i);if(b){h.itemCombo.setUniqueKey(b)}}$(h.itemCombo.DOMelem_input).focus(function(){$(this).closest("td").addClass("cell-active")}).blur(function(){$(this).closest("td").removeClass("cell-active")})},loadItem:function(a,b){var c=this;if(!a){a=""}this.description.blur().val("").parent().addClass("loading").removeClass("cell-active");$.ajax({url:"/ajax/"+this.ajax_function,dataType:"json",data:{unique_key:a},success:function(d){c._handleLoadResponse(b,d)},error:function(d){var e=JSON.parse(d.responseText);if(e.error.message){alert(e.error.message)}},complete:function(){c.description.parent().removeClass("loading");b.find("td").removeClass("cell-active");c.description.trigger("focus");c.parentTable.disableUpdates=false;$(document).trigger("invoice.updateTotal")}})},_handleLoadResponse:function(h,a){this.parentTable.disableUpdates=true;for(var d in this.loadItemMap){var g=this.loadItemMap[d];var f=a[g];if(!g){f=0}this[d].val(f)}this.itemCombo.setUniqueKey(a[this.uniqueKeyField]);this.description.trigger("change");var e=decimalizeMoney(this.unit_cost.val());this.base_value=e;this.unit_cost.val(e);var c=a.tax1?JSON.stringify(a.tax1):"{}";this.tax1combo.setComboValue(c);var b=a.tax2?JSON.stringify(a.tax2):"{}";this.tax2combo.setComboValue(b)},remove:function(c){var b=this;var d=b.line;if(typeof c==="undefined"){c={animate:true}}var a=function(){d.remove();b.parentGroup.hideIfEmpty();$(document).trigger("invoice.updateTotal");b.parentTable.dirty()};c.animate?d.fadeOut("fast",a):a()},prepareItemOptions:function(a){if(this.optionButton){a.push(this.optionButton)}return a},reloadItems:function(a){this.itemCombo.clearAll();this.itemCombo.addOption(this.prepareItemOptions(a))}});Fresh.InvoiceItemLine=Fresh.InvoiceLine.extend({loadItemMap:{qty:"qty",unit_cost:"unit_cost",description:"description"},uniqueKeyField:"itemid",build:function(b){var a=this;this._super(b);a.setType(Fresh.InvoiceBase.ITEM);a.initCombo(b,"div.item-name-container","item_name[]","item/get",a.parentTable.itemOptions,a.parentTable.newItemOption);return a}});Fresh.InvoiceTimeLine=Fresh.InvoiceLine.extend({loadItemMap:{qty:null,unit_cost:"rate_formatted",description:"tdesc"},uniqueKeyField:"taskid",build:function(b){var a=this;this._super(b);a.setType(Fresh.InvoiceBase.TIME_ENTRY);a.initCombo(b,"div.task-name-container","item_name[]","task/get",a.parentTable.taskOptions,a.parentTable.newTaskOption);return a},focus:function(){$(this.itemCombo.DOMelem_input).focus()}});Fresh.InvoiceGroup=Class.extend({BLANK_LINE:{name:"",desc:"",unit_cost:"",qty:"",tax1:"{}",tax2:"{}",tax1_text:"",tax2_text:"",expenseid:"",logid_list:"",todo:""},isLastLineBlank:function(){if(this.initialLineCount==0){return false}return this.lastLine.blank()},getInitialLineCount:function(){return this.initialLineCount},disableLines:function(){var a=this;a.container.addClass("disabled").find("tr:not(.inline-item)").each(function(){var b=$(this).data("line");if(!b){return}b.disable()})},enableLines:function(){var a=this;a.container.removeClass("disabled").find("tr:not(.inline-item)").each(function(){var b=$(this).data("line");if(!b){return}b.enable()})},init:function(b){var a=this;a.initialLineCount=0;a.parentTable=b;a.container=$(a.tableId);a.button.closest("li").show().click(function(){var c=a.addLineOnClick();c[0].focus();return false});a.container.delegate("td.has-combobox","click",function(c){$(this).find("input[type=hidden]:first").data("combobox").openSelect();c.preventDefault();c.stopPropagation()});a.container.delegate("td.editable","click",function(c){$(this).find(":input:visible:first").focus()});a.container.delegate("tbody .delete","click",function(c){var d=$(this).closest("tr");c.preventDefault();c.stopPropagation();a.parentTable.closeOpenDialogs();d.data("line").remove()});a.container.delegate("thead .delete","click",function(d){var f=$(this).closest("tr");var c="This group contains one or more lines. Are you sure you want to delete it?";a.parentTable.closeOpenDialogs();d.preventDefault();d.stopPropagation();if(!a.isEmpty()&&!confirm(c)){return}a.removeAllLines()});a.container.delegate("tbody .insert","click",function(c){var d=$(this).closest("tr");var f=a.addBlankLine(true,d);a.parentTable.closeOpenDialogs();f.focus();return false})},addLine:function(d,c,f){var b=this;b.initialLineCount++;if(!b.template){b.template=Fresh.Util.getTemplate(b.templateId)}var e=$(b.template.expand(d));if(typeof(f)!="undefined"){f.after(e)}else{b.container.find("tbody").append(e)}d.price=b.parentTable.currency.format(d.price);var a=b.getLineObject(e);a.build(d);b.lastLine=a;e.data("line",a);if(typeof(c)=="undefined"){c=true}if(c){b.refreshRowOrder()}a.show();return a},addLineOnClick:function(){var b=this;b.parentTable.closeOpenDialogs();var a=[];if(b.container.is(":visible")){a=[b.addBlankLine()]}else{for(var c=0;c<b.parentTable.MIN_LINES;c++){a.push(b.addBlankLine())}}b.showIfLines();return a},addBlankLine:function(c,d){var b=this;var a=b.addLine(b.BLANK_LINE,c,d);b.showIfLines();return a},removeAllLines:function(){var a=this;var b=a.container.find("tbody tr");b.each(function(){$(this).data("line").remove({animate:false})})},hideIfEmpty:function(){var a=this;if(a.container.find("tbody tr:first").length==0){a.container.hide()}},show:function(){this.container.show()},showIfLines:function(){var a=this;if(this.container.find("tbody tr").length>0){this.show()}},refreshRowOrder:function(){var a=this;return $(a.container).tableDnDUpdate()},isEmpty:function(){var a=this.container.find("tbody tr").filter(function(c){var b=$(this).data("line");return !b.blank()});return a.length===0},reloadItems:function(){var a=this;this.container.find("tr").each(function(c,d){var b=$(this).data("line");if(b){b.reloadItems(a.itemOptions.slice())}})}});Fresh.InvoiceItemGroup=Fresh.InvoiceGroup.extend({init:function(b){var a=this;a.tableId="#invoice-items";a.templateId="#invoice-item-row-tpl";a.parentTable=b;a.button=$("#new-item");this.itemOptions=b.itemOptions;this._super(b)},getLineObject:function(a){return new Fresh.InvoiceItemLine(this,a)},newPopup:function(g){var k=this;var m=$(g.DOMelem_input).closest("tr").hide();var b=m.after(Fresh.Util.getTemplate("#new-item-row-tpl").expand()).next();var l=new Fresh.NewInvoiceItemLine(k,b);l.build({taxes:k.parentTable.taxOptions}).show();b.find("input:visible:first").focus();b.data("line",l);k.disableLines();var h=function(){alert("You must either save or cancel your re-usable item before continuing.");b.find('input[name="item_name[]"]').focus();return false};var d=function(){k.enableLines();b.remove();m.show();$("input[type=image]").unbind("click",h);if(typeof send_by_email_onclick==="function"){$("#send_by_email_button").unbind("click",send_by_email_onclick).bind("click",send_by_email_onclick)}};var c=b.find("a:contains(cancel)");var f=b.find("a:contains(Save)");var i=function(){g.selectOption(g.indexBeforeOnChange,false,false);g.DOMelem_hidden_input.value=g.optionsArr[g.indexBeforeOnChange].value;d();return false};var j=function(){f.unbind("click").trigger("blur");c.unbind("click");g.setComboValue("");b.find("div.buttons").addClass("disabled");var o=b.find('input[name="tax11[]"]').val();var n=b.find('input[name="tax22[]"]').val();$.ajax({url:"/ajax/item/create",dataType:"json",data:{name:b.find('input[name="item_name[]"]').val(),description:b.find('textarea[name="descrip[]"]').val(),unit_cost:b.find('input[name="unit_cost[]"]').val(),qty:b.find('input[name="qty[]"]').val(),tax1:o,tax2:n},success:a,error:e,type:"POST",complete:function(){b.find("div.buttons").removeClass("disabled");f.bind("click",j);c.bind("click",i)}});return false};var e=function(n){var o=JSON.parse(n.responseText);b.find('input[name="item_name[]"]').trigger("focus");b.find("#item-msg").html(o.error).show().addClass("error")};var a=function(n){var p=n.name;var o=n.itemid;k.parentTable.itemOptions.push({value:p,text:html_escape(p),unique_key:o});d();k.reloadItems();$(g.DOMelem_input).trigger("focus");g.setComboValueByUniqueKey(o);if(_autosend_alert_popup){$("[name=save]").click(_autosend_alert_popup)}return false};f.click(j);c.click(i);$("input[type=image]").unbind("click").bind("click",h);return false}});Fresh.InvoiceTimeGroup=Fresh.InvoiceGroup.extend({init:function(b){var a=this;a.parentTable=b;a.tableId="#invoice-time";a.templateId="#invoice-time-row-tpl";a.button=$("#new-time");this.itemOptions=b.taskOptions;this._super(b)},getLineObject:function(a){return new Fresh.InvoiceTimeLine(this,a)},newPopup:function(g){var k=this;var m=$(g.DOMelem_input).closest("tr").hide();var b=m.after(Fresh.Util.getTemplate("#new-task-row-tpl").expand()).next();var l=new Fresh.NewInvoiceItemLine(k,b);l.build({taxes:k.parentTable.taxOptions}).show();l.tax1combo.disable(true);l.tax2combo.disable(true);b.find("input:visible:first").focus();b.data("line",l);k.disableLines();var h=function(){alert("You must either save or cancel your re-usable task before continuing.");b.find('input[name="item_name[]"]').focus();return false};var d=function(){k.enableLines();b.remove();m.show();$("input[type=image]").unbind("click",h);if(typeof send_by_email_onclick==="function"){$("#send_by_email_button").unbind("click",send_by_email_onclick).bind("click",send_by_email_onclick)}};var c=b.find("a:contains(cancel)");var f=b.find("a:contains(Save)");var i=function(){g.selectOption(g.indexBeforeOnChange,false,false);g.DOMelem_hidden_input.value=g.optionsArr[g.indexBeforeOnChange].value;d();return false};var j=function(){f.unbind("click").trigger("blur");c.unbind("click");b.find("div.buttons").addClass("disabled");g.setComboValue("");var o=b.find('input[name="tax11[]"]').val();var n=b.find('input[name="tax22[]"]').val();$.ajax({url:"/ajax/task/create",data:{"task[tname]":b.find('input[name="item_name[]"]').val(),"task[rate]":b.find('input[name="unit_cost[]"]').val(),"task[tdesc]":b.find('textarea[name="descrip[]"]').val(),"task[billable]":b.find('input[name="unit_cost[]"]').val()?"1":"0","task[all_projects]":"0"},dataType:"json",type:"POST",success:a,error:e,complete:function(){b.find("div.buttons").removeClass("disabled");f.bind("click",j);c.bind("click",i)}});return false};var e=function(n){var o=JSON.parse(n.responseText);b.find('input[name="item_name[]"]').focus();b.find("#item-msg").html(o.error).show().addClass("error")};var a=function(o){var n=o.tname;var p=o.taskid;k.parentTable.taskOptions.push({value:n,text:html_escape(n),unique_key:p});d();k.reloadItems();$(g.DOMelem_input).trigger("focus");g.setComboValueByUniqueKey(p);if(_autosend_alert_popup){$("[name=save]").click(_autosend_alert_popup)}return false};f.click(j);c.click(i);$("input[type=image]").unbind("click").bind("click",h);return false}});Fresh.InvoiceBase=Class.extend({ITEM:0,EXPENSE:1,TIME_ENTRY:2,LATE_FEE:3,MIN_LINES:3,NEW_CLIENT:"NEW",lineGroups:[],_afterClientUpdate:function(){},setSubtotal:function(a){a=this.currency.round(a);$("#subtotal-row td:last").html(this.currency.format(a,{symbol:true}));$("input[name=subtotal]").val(a)},setTotal:function(b){b=this.currency.round(b);$("#amount-row td:last").html(this.currency.format(b,{symbol:true}));$("input[name=amount]").val(b);var a=this.currency.code?"("+this.currency.code+")":"";$("span.currency").html(a)},setPaidToDate:function(a){a=this.currency.round(a);$("#paid-row td:last").html(this.currency.format(a,{symbol:false}))},setOutstanding:function(a){a=this.currency.round(a);$("#outstanding-row td:last").html(this.currency.format(a,{symbol:true}));$("input[name=outstanding]").val(a)},setDiscountTotal:function(a){a=this.currency.round(a);$("#discount-total-row td:last").html(this.currency.format(a,{symbol:false}));$("input[name=discount_total]").val(a)},closeOpenDialogs:function(){var a=$("#invoice-lines table tbody tr:first").find('input[name="tax11[]"]').data("combobox");if(a){a.closeAll()}},beginLoading:function(){var a=this;a.progressBar=$("#progress-bar");a.currentProgress=0;$.each(a.lineGroups,function(b,c){c.hideIfEmpty()});$("#progress-container").show()},endLoading:function(){var a=this;$.each(this.lineGroups,function(b,c){c.showIfLines()});$("#progress-container").hide();a._forceLineDefaults("items",a.itemGroup);a._forceLineDefaults("time",a.timeGroup)},_forceLineDefaults:function(b,d){var a=this;if((a.defaultLines==b||a.defaultLines=="both"||d&&d.getInitialLineCount()>0)&&(d&&(!d.isLastLineBlank()||d.getInitialLineCount()<3))){var c=0;var e=(3-d.getInitialLineCount());do{d.addBlankLine(false)}while(e-(++c)>0)}},updateProgressBar:function(a){var b=this;if(!b.progressBar){return}b.progressBar.css("width",(a*100)+"%")},initLines:function(a){var b=this;if(typeof(_invoice_items.name)=="undefined"){function h(k){if(k<b.MIN_LINES){if(b.itemGroup&&(b.defaultLines=="items"||b.defaultLines=="both")){b.itemGroup.addBlankLine(false)}if(b.timeGroup&&(b.defaultLines=="time"||b.defaultLines=="both")){b.timeGroup.addBlankLine(false)}if(k==0){endTime=new Date().getTime();var j=(endTime-g)*b.MIN_LINES*2;if(j>250){b.beginLoading()}}b.updateProgressBar(k/b.MIN_LINES);setTimeout(function(){h(++k)},0)}else{b.updateProgressBar(1);$.each(b.lineGroups,function(i,l){l.refreshRowOrder();l.showIfLines()});b.endLoading();$(document).trigger("invoice.updateTotal")}}var g=new Date().getTime();if(!b.defaultLines){b.defaultLines="items";$.facebox({div:"#invoice_headings_popup"},"no-close-button");$("#set_invoice_headings").live("click",function(){b.defaultLines=$("input[name=invoice_headings_radio]:checked").val();$.each(b.lineGroups,function(i,j){j.removeAllLines()});h(0);$.post("/ajax/system/setDefaultLineType",{lineType:b.defaultLines});$(document).trigger("close.facebox");return false})}else{h(0)}return}var d=a.name.length;var f=null;var g=new Date().getTime();function c(l,t){var v=Math.min(d,l+t);for(var q=l;q<v;q++){switch(parseInt(a.type[q],10)){case b.ITEM:case b.EXPENSE:case b.LATE_FEE:lineGroup=b.itemGroup;break;case b.TIME_ENTRY:lineGroup=b.timeGroup;break;default:lineGroup=b.itemGroup}var k=a.name[q];var y=a.qty[q];var o=a.unit_cost[q];var s=a.descrip[q];var x=a.tax1[q];var w=a.tax2[q];var n=Boolean(x.name);var j=Boolean(w.name);var m=a.todo_ids[q];var r=(typeof a.taskid==="object")?a.taskid[q]:null;var p=(typeof a.lineid==="object")?a.lineid[q]:null;if(k||s||n||j||parseFloat(y)||parseFloat(o)){o=decimalizeMoney(o);y=y==""?"0":y}else{y="";o=""}f=lineGroup.addLine({name:k,desc:s,unit_cost:o,qty:y,expenseid:a.expenseid?a.expenseid[q]:"",logid_list:a.logid?a.logid[q]:"",tax1:JSON.stringify(x),tax2:JSON.stringify(w),tax1_text:a.taxName1[q],tax2_text:a.taxName2[q],type:a.type?a.type[q]:"0",todo:m,taskid:r,lineid:p},false);if(g){endTime=new Date().getTime();var u=(endTime-g)*d;if(u>250){b.beginLoading()}g=null}}b.updateProgressBar(q/d);if(q<d){setTimeout(function(){c(q,t)},0)}else{b.updateProgressBar(1);setTimeout(function(){if(!f.blank()){lineGroup.addBlankLine(false)}$(document).trigger("invoice.updateTotal");$.each(b.lineGroups,function(i,z){z.refreshRowOrder()});b.endLoading()},0)}}var e=Math.ceil(d/15);c(0,e)},reloadItems:function(){$.each(this.lineGroups,function(a,b){b.reloadItems()})},applyExchange:function(a){$("table.invoice-lines tbody tr").each(function(){$this=$(this);var b=$(this).data("line");if(b.unit_cost.val()){var c=Currency.base.round(b.base_value*a);b.unit_cost.val(c)}});$(document).trigger("invoice.updateTotal")},updateTotals:function(){var g=this;if(g.disableUpdates){return}var f;var d=0;var a={};var e=0;var b=parseFloat($("input[name=discount_value]").val());if(b>0){$("#discount-total-row").show()}else{$("#discount-total-row").hide()}$("table.invoice-lines tbody tr").each(function(){$this=$(this);var j=$(this).data("line");var o=j.unit_cost.val();var p=j.qty.val();f=parseFloat(g.currency.round(p*o));j.setPrice(g.currency.round(f));if(f){d+=f}if(b>0){f=parseFloat(f-f*b/100)}var q={name:"",amount:0,value:0,compound:false};var l=$.extend({},q,JSON.parse(j.tax1combo.getSelectedValue()));var k=$.extend({},q,JSON.parse(j.tax2combo.getSelectedValue()));var n=l.name+Math.round(l.amount*10000)/10000+l.compound;var m=k.name+Math.round(k.amount*10000)/10000+k.compound;if(l&&(l.name||l.amount)){if(!a[n]){a[n]=l}a[n].value+=f*l.amount/100;e++}if(k&&(k.name||k.amount)){if(!a[m]){a[m]=k}if(l.amount&&k.compound){a[m].value+=(f+f*l.amount/100)*k.amount/100}else{a[m].value+=f*k.amount/100}e++}});var c=0;if(b>0){c=parseFloat(d*b/100)}g.setDiscountTotal(-c);c=g.currency.round(c);if(!b&&!e){$("table.table-totals thead").hide()}else{$("table.table-totals thead").show()}var i=parseFloat(d)-parseFloat(c);$(".tax-row").remove();$.each(a,function(j,l){var k=g.currency.round(parseFloat(l.value));i+=parseFloat(k);var m=l.name;var n=String(parseFloat(l.amount));$("table.table-totals thead tr.divider").before(g.taxTemplate.expand({taxAmountRounded:k,taxName:m,taxPercent:n}))});g.setSubtotal(d);g.setTotal(i);$(document).trigger("fb.invoice_base.update_totals",{total:i});if($("input[name=invoice_type]").val()=="invoice"){var h=$("input[name=paid]").val();g.setPaidToDate(h);g.setOutstanding(i-h)}$("table.table-totals tr:last").addClass("invoice-total-box")},updateTaxes:function(a){var f,e,b,d,g=this;this.taxes=a;this.taxOptions=[{value:"{}",text:""}];for(var c in a){if(a[c]["name"]==""||a[c]["name"]===undefined){continue}this.taxOptions.push({value:JSON.stringify(a[c]),text:a[c]["name"].htmlentities()})}$("table.invoice-lines tbody td input.invTax").each(function(){var i=this;var l=$(i).hasClass("leftTax");var h=$(this).data("combobox");h.render(false);var j={value:h.getSelectedValue(),text:h.getSelectedText()};h.clearAll(false);var k=[];if(j.text){k.push(j)}k=$.merge(k,g.taxOptions);k.push(g.editTaxesOption);h.addOption(k)})},_getOutstandingClientExpenses:function(a,c){var b=function(e,f,d){clients_with_expenses[a]=e;c(e)};if(clients_with_expenses[a]==null){$.ajax({url:"/ajax/expense/getOutstandingForClient",type:"GET",data:{clientid:a},success:b,dataType:"json"})}else{c(clients_with_expenses[a])}},_showOrHideAddExpenseLink:function(a){$("#outstanding-expenses").hide();if(!a){return}this._getOutstandingClientExpenses(a,function(b){if(!b||b.length==0){$("#outstanding-expenses").hide()}else{$("#outstanding-expenses").show()}})},showContacts:function(c){$("#contact-section").hide();this.clientHelpBubble.hide();var b,h=0,k,e,j,a="",g='<input class="checkbox" type="checkbox" id="contactid-{contactid}" name="contacts[]" value="{contactid}"{checked} /> <label style="cursor:pointer;" for="contactid-{contactid}">{name}</label><br />',f=jsontemplate.Template(g,{undefined_str:""});k=window.js_contact_list;var d=false;for(b in k){e=k[b];if(e.userid!=c){continue}h++;j=(e.checked)?' checked="checked" ':"";if(j==' checked="checked" '){d=true}a+=f.expand({contactid:e.contactid,name:e.name.htmlentities(),checked:j})}$("#contact_info").html(a);if(a){$("#contact-section").show()}if(!d){$("#contactid--1").attr("checked","checked")}document.forms[0].num_contacts.value=h;return a},setAdvancedCheckboxes:function(a,d){var c=Number(a);var b=Number(d);if(c){$("#client_late_fees").attr("checked","checked")}else{$("#client_late_fees").removeAttr("checked")}if(b){$("#client_late_notify").attr("checked","checked")}else{$("#client_late_notify").removeAttr("checked")}},refreshClient:function(b){var a=this;$("#address").css("height",45).html("Loading...");$("#address-section, #client_tags").hide();a.clientHelpBubble.hide();if(typeof(b)=="undefined"){b=$("input[name=customerid]").val()}$.ajax({url:"/ajax/client/get",dataType:"json",data:{clientid:b},success:function(c){document.form.oldaddress.value="";a.EditClientPanel.updateFromResponse(c);$("#address-section").show();var e=c.language||"en";var d=c.currency_code;if(!d){d=Currency.base.code}if(d=="none"){d=""}a.setCurrencyCode(d);$("#currency_code").val(d);$("#client_language").val(e);a.setAdvancedCheckboxes(c.allow_late_fees,c.allow_late_notifications);a._afterClientUpdate();a.AdvancedSettings.setValues(a.currency.code,language_lookup[e],c.allow_late_fees,c.allow_late_notifications);a.credit={};if($("#credit").length){jQuery.each(c.credit,function(f,g){a.credit[f]=g})}$(document).trigger("invoice.refreshClient")}})},refreshContactPreference:function(e){var b,c;var a=window.js_mail_pref;if(a[e]){b=a[e]["email"];c=a[e]["gmail"]}var d=$('<img width="17" height="17" />').attr("src",Fresh.ENV_IMAGE_DIR+"/2ndSite/greenStar.gif");$("#pref_email").html(parseInt(b,10)?d:"");$("#pref_gmail").html(parseInt(c,10)?d:"")},clientOnChange:function(b){var a=this;if(b==this.NEW_CLIENT){this.EditClientPanel.backupData();this.EditClientPanel.show("create");return true}else{if(b){a.EditClientPanel.oldCustomerId=b;a.refreshClient(b);a.showContacts(b)}else{a.EditClientPanel.oldCustomerId="";$("input[name=client_credit]").val(0);$("#contact-section, #address-section, #client_tags").hide();a.clientHelpBubble.show()}}if(this.showExpenses){a._showOrHideAddExpenseLink(b)}$("#customerid").removeClass("errorInput")},setCurrencyCode:function(a){if(a=="---"){$("#currency_code").val(this.currency.code);return false}a=(a=="---"?"":a);this.currency=new Currency(a);if(this.currency.code>""){$("#currency_tag").html("<span>"+this.currency.code+"</span>")}else{$("#currency_tag").html("<span>none</span>")}if(a!=Currency.base.code){$("#set_exchange_rate").fadeIn();$("span[rel=selected_currency_code]").html(a)}else{$("#set_exchange_rate").fadeOut()}$("#late-amount-pre").html(this.currency.symbol.html);this._exchange_modified=false;$(document).trigger("invoice.updateTotal")},init:function(c){var a=this;a._exchange_modified=false;a.credit={};a.currency=c.currency;a.language=c.language;a.template=c.template;a.showExpenses=c.showExpenses!==undefined?c.showExpenses:true;this.taxTemplate=Fresh.Util.getTemplate("#invoice-tax-template");a.defaultLines=c.defaultLines;a.clientHelpBubble=$(c.clientHelpBubble);var b=$("#customerid").val();a.AdvancedSettings=new Fresh.AdvancedSettings(a);a.EditClientPanel=new Fresh.EditClientPanel();if(b>""){$.ajax({type:"GET",url:"/ajax/client/get",dataType:"json",data:{clientid:b},success:function(d){a.EditClientPanel.setClient(d);a.setAdvancedCheckboxes(d.allow_late_fees,d.allow_late_notifications);a.AdvancedSettings.setValues(a.currency.code,language_lookup[a.language],d.allow_late_fees,d.allow_late_notifications)}})}$("#apply-exchangepop").live("click",function(){a.applyExchange($("#exchange-exchangepop").val());$(document).trigger("close.facebox");return false});$("#apply-exchangelink").live("click",function(){if(!a._exchange_modified){$.post("/ajax/system/getExchangeRate",{from:Currency.base.code,to:$("#currency_code").val()},function(d){$xml=$(d);var e=$xml.find("rate").text();$("#exchange-exchangepop").val(clampdec(parseFloat(e),8));$.facebox({div:"#edit_exchange_popup"})});a._exchange_modified=true}else{$.facebox({div:"#edit_exchange_popup"})}$("#edit_exchange_popup textarea:first").focus();return false});$("#cancel-exchangepop").live("click",function(){$(document).trigger("close.facebox");return false});$("#customerid").each(function(){var d=$(this).val();if(!d){a.clientHelpBubble.show("fast")}else{if(c.showExpense){a._showOrHideAddExpenseLink(d)}if(c.refreshAddress){a.refreshClient(d)}a.showContacts(d);a.refreshContactPreference(d);$("#send-by-section").show();$("#address-section").show()}}).change(function(d){var e=$(this).val();a.clientOnChange(e)});a.itemOptions=[];if(c.items){$.each(c.items,function(e,d){a.itemOptions.push({value:d,text:html_escape(d),unique_key:e})})}if(c.newItem){a.newItemOption={value:"-1",text:"New Item",className:"combobox-action"};a.newTaskOption={value:"-1",text:"New Task",className:"combobox-action"}}a.taskOptions=[];if(c.tasks){$.each(c.tasks,function(e,d){a.taskOptions.push({value:d,text:html_escape(d),unique_key:e})})}this.taskOptions.sort(Fresh.Array.sortComboboxItems);this.itemOptions.sort(Fresh.Array.sortComboboxItems);if(!c.groups||c.groups["item"]){a.itemGroup=new Fresh.InvoiceItemGroup(a);a.lineGroups.push(a.itemGroup)}if(!c.groups||c.groups["time"]){a.timeGroup=new Fresh.InvoiceTimeGroup(a);a.lineGroups.push(a.timeGroup)}a.taxes=c.taxes;a.taxOptions=[];a.taxOptions.push({value:"{}",text:""});$.each(c.taxes,function(e,d){a.taxOptions.push({value:JSON.stringify(d),text:d.name.htmlentities()})});if(c.editTaxes){a.editTaxesOption={value:"-1",text:"Edit",className:"combobox-action"}}$("table.invoice-lines").tableDnD({dragHandle:"action-buttons",onDragClass:"on-drag",onDragStart:function(){a.closeOpenDialogs();$("td.cell-active").removeClass("cell-active");$("body").addClass("cursor-move")},onDrop:function(){$("body").removeClass("cursor-move")}});$("#discount_value").change(function(){$(document).trigger("invoice.updateTotal")});$(":input:visible").change(function(){a.dirty()});$(window).bind("beforeunload",function(d){$(document).focus();if(a.isDirty()){return"Are you sure you want to leave this page? You have unsaved edits."}});$(".invoice_submit").live("click",function(d){$(window).unbind("beforeunload")});$(document).bind("invoice.updateTotal",function(){a.updateTotals()})},dirty:function(){this._dirty=true},isDirty:function(){return this._dirty}});Fresh.PayableInvoiceBase=Fresh.InvoiceBase.extend({init:function(b){this._super(b);var a=this;$("#currency_code").change(function(){var c=new Currency($(this).val());a.enableOrDisableSingleCurrencyGateways(c.isBase())});$("#add-expenses").click(function(){var c=$("#customerid").val();$("#outstanding-expenses").hide();a.createExpensesForUser(c);return false});a.enableOrDisableSingleCurrencyGateways(a.currency.isBase(),!document.form.estimateid);$("#gateway_paypaladaptive").bind("click",this.onlinePaymentPayPalOnChange);this.onlinePaymentPayPalOnChange()},_afterClientUpdate:function(){this.enableOrDisableSingleCurrencyGateways(this.currency.isBase())},enableOrDisableSingleCurrencyGateways:function(a,b){if(typeof b==="undefined"){b=false}if(a){$('input[name="gateway[]"]').removeAttr("disabled").next("label").css("color","#000")}else{if(!b||!$('input[name="gateway[]"]').is(":checked")){$('input[name="gateway[]"]:not([value=20])').removeAttr("checked").attr("disabled","disabled").next("label").css("color","#888")}}},createExpensesForUser:function(b){var a=this;if(b==undefined){return}var c=a._getOutstandingClientExpenses(b,function(d){var f="";var e=a.itemGroup.isEmpty();$.each(d,function(k,l){var g=String(l.expenseid);var n=String(l.vendor);var j=String(l.notes);var h=String(l.amount);var m="["+l.date+"] "+l.category;if(n){m+=", "+n}if(j){m+=": "+j}a.itemGroup.addLine({name:"Expense",desc:m,unit_cost:h,qty:"1",price:h,expenseid:g,logid_list:"",tax1:"{}",tax2:"{}",tax1_text:"",tax2_text:"",type:Fresh.EXPENSE})});$("#the_items tr:has(.addLine):last").before(f);if(e){a.itemGroup.show()}$(document).trigger("invoice.updateTotal")})},onlinePaymentPayPalOnChange:function(){var c=$("#gateway_paypaladaptive:checked").length;var b=$("#currency_code option:selected").val();var a=$("#system_eligible_for_b2b").val();if(c&&a&&b=="USD"){$("#gateway_option_paypaladaptive").show();$("#paypal_fee_type_options").show().find("input[type=radio]").removeAttr("disabled");$(".invoice_gateway_list.paypal").addClass("paypal_checked")}else{$("#gateway_option_paypaladaptive").show();$("#paypal_fee_type_options").hide().find("input[type=radio]").attr("disabled","disabled");$(".invoice_gateway_list.paypal").removeClass("paypal_checked").show()}}});Fresh.Invoice=Fresh.PayableInvoiceBase.extend({init:function(b){var a=this;this._super(b);this.last_total=0;this.last_currency_code="";this.credit_selected=false;$(document).bind("invoice.refreshClient",function(){a.refreshCredit();a.onlinePaymentPayPalOnChange()});$(document).bind("fb.invoice_base.update_totals",function(){a.refreshCredit()});$("#currency_code").change(function(){a.refreshCredit();a.onlinePaymentPayPalOnChange()});a.refreshCredit()},refreshCredit:function(){var a=this;if(document.form.invoiceid.value){return}var b=parseFloat($("input[name=amount]").val());var c=a.credit[a.currency.code];if(c&&c>0){c=a.currency.round(Fresh.Math.clamp(c,0,b));$("#credit_amount").html(c);$("#apply_credit").removeAttr("disabled");$("#credit").show()}else{if($("#credit").html()!=""){$("#credit").hide();$("#apply_credit").attr("disabled","disabled")}}},clientOnChange:function(b){var a=this;a._super(b);a.refreshContactPreference(b)}});Fresh.Recurring=Fresh.PayableInvoiceBase.extend({init:function(c){var a=this;this._super(c);a.autosend=c.autosend;$("#numberRecurring").blur(function(){if($(this).val()==""){var d=$("<div></div>").html("infinite").html();$(this).val(d)}}).focus(function(){if(!parseInt($(this).val(),10)){$(this).val("")}});$(document).bind("invoice.refreshClient",function(){a.onlinePaymentPayPalOnChange()});var b=$("#auto_gateway");if(b.length){b.bind("change",function(){a.toggleAutoBill($(this).val())});if(b.val()){a.toggleAutoBill(b.val())}}else{a.toggleAutoBill("")}$("#currency_code").bind("change",function(){var d=new Currency($(this).val());a.enableOrDisableAutoGateway(d.isBase());a.onlinePaymentPayPalOnChange()});a.enableOrDisableAutoGateway(a.currency.isBase(),true);a.onlinePaymentPayPalOnChange()},toggleAutoBill:function(d){var e="#gateway-type-1",b="#gateway-type-2",a,c;if(!d){$("div.bookcase.creditcard").hide().find(":input").attr("disabled","disabled").val("");return}if(d=="electracash"){a=b;c=e}else{a=e;c=b}$(a).show().find(":input").removeAttr("disabled");$(c).hide().find(":input").attr("disabled","disabled").val("")},_afterClientUpdate:function(){this._super();this.enableOrDisableAutoGateway(this.currency.isBase())},enableOrDisableAutoGateway:function(a,b){if(typeof(b)==="undefined"){b=false}if(a){$("#auto_gateway").removeAttr("disabled")}else{if(!b||!$("#auto_gateway").val()){$("#auto_gateway").val("").attr("disabled","disabled");if($("div.creditcard:visible").length){$("#auto_gateway").trigger("change")}}}},clientOnChange:function(b){var a=this;this._super(b);if(a.autosend&&b&&b!=this.NEW_CLIENT){a.changeMailPref(b);$("#send-by-section").show()}else{if(b!=this.NEW_CLIENT){$("#send-by-section").hide()}}},changeMailPref:function(b){var h,g,e,f,c,d,a=window.js_mail_pref;if(a[b]){e=a[b]["email"];f=a[b]["gmail"]}c=$("#send_by_email");d=$("#send_by_gmail");if(e==0){c.removeProp("checked")}else{c.prop("checked",true)}if(f==0){d.removeProp("checked")}else{d.prop("checked",true)}}});Fresh.Support=Fresh.InvoiceBase.extend({init:function(a){this._super(a);$("#show-items").click(function(){$("#support-new-item").hide();$("#the_items").show();$("#the_items").append('<input type="hidden" name="lines_posted" value="1"/>');return false})}});jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(a){this.each(function(){this.tableDnDConfig=jQuery.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,serializeRegexp:/[^\-]*$/,serializeParamName:null,dragHandle:null},a||{});jQuery.tableDnD.makeDraggable(this)});jQuery(document).bind("mousemove",jQuery.tableDnD.mousemove).bind("mouseup",jQuery.tableDnD.mouseup);return this},makeDraggable:function(c){var b=c.tableDnDConfig;if(c.tableDnDConfig.dragHandle){var a=jQuery("td."+c.tableDnDConfig.dragHandle,c);a.each(function(){jQuery(this).mousedown(function(e){jQuery.tableDnD.dragObject=this.parentNode;jQuery.tableDnD.currentTable=c;jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,e);if(b.onDragStart){b.onDragStart(c,this)}return false})})}else{var d=jQuery("tr",c);d.each(function(){var e=jQuery(this);if(!e.hasClass("nodrag")){e.mousedown(function(f){if(f.target.tagName=="TD"){jQuery.tableDnD.dragObject=this;jQuery.tableDnD.currentTable=c;jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,f);if(b.onDragStart){b.onDragStart(c,this)}return false}}).css("cursor","move")}})}},updateTables:function(){this.each(function(){if(this.tableDnDConfig){jQuery.tableDnD.makeDraggable(this)}})},mouseCoords:function(a){if(a.pageX||a.pageY){return{x:a.pageX,y:a.pageY}}return{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(d,c){c=c||window.event;var b=this.getPosition(d);var a=this.mouseCoords(c);return{x:a.x-b.x,y:a.y-b.y}},getPosition:function(c){var b=0;var a=0;if(c.offsetHeight==0){c=c.firstChild}while(c.offsetParent){b+=c.offsetLeft;a+=c.offsetTop;c=c.offsetParent}b+=c.offsetLeft;a+=c.offsetTop;return{x:b,y:a}},mousemove:function(g){if(jQuery.tableDnD.dragObject==null){return}var d=jQuery(jQuery.tableDnD.dragObject);var b=jQuery.tableDnD.currentTable.tableDnDConfig;var i=jQuery.tableDnD.mouseCoords(g);var f=i.y-jQuery.tableDnD.mouseOffset.y;var c=window.pageYOffset;if(document.all){if(typeof document.compatMode!="undefined"&&document.compatMode!="BackCompat"){c=document.documentElement.scrollTop}else{if(typeof document.body!="undefined"){c=document.body.scrollTop}}}if(i.y-c<b.scrollAmount){window.scrollBy(0,-b.scrollAmount)}else{var a=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;if(a-(i.y-c)<b.scrollAmount){window.scrollBy(0,b.scrollAmount)}}if(f!=jQuery.tableDnD.oldY){var e=f>jQuery.tableDnD.oldY;jQuery.tableDnD.oldY=f;if(b.onDragClass){d.addClass(b.onDragClass)}else{d.css(b.onDragStyle)}var h=jQuery.tableDnD.findDropTargetRow(d,f);if(h){if(e&&jQuery.tableDnD.dragObject!=h){jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,h.nextSibling)}else{if(!e&&jQuery.tableDnD.dragObject!=h){jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,h)}}}}return false},findDropTargetRow:function(f,g){var j=jQuery.tableDnD.currentTable.rows;for(var e=0;e<j.length;e++){var h=j[e];var b=this.getPosition(h).y;var a=parseInt(h.offsetHeight)/2;if(h.offsetHeight==0){b=this.getPosition(h.firstChild).y;a=parseInt(h.firstChild.offsetHeight)/2}if((g>b-a)&&(g<(b+a))){if(h==f){return null}var c=jQuery.tableDnD.currentTable.tableDnDConfig;if(c.onAllowDrop){if(c.onAllowDrop(f,h)){return h}else{return null}}else{var d=jQuery(h).hasClass("nodrop");if(!d){return h}else{return null}}return h}}return null},mouseup:function(c){if(jQuery.tableDnD.currentTable&&jQuery.tableDnD.dragObject){var b=jQuery.tableDnD.dragObject;var a=jQuery.tableDnD.currentTable.tableDnDConfig;if(a.onDragClass){jQuery(b).removeClass(a.onDragClass)}else{jQuery(b).css(a.onDropStyle)}jQuery.tableDnD.dragObject=null;if(a.onDrop){a.onDrop(jQuery.tableDnD.currentTable,b)}jQuery.tableDnD.currentTable=null}},serialize:function(){if(jQuery.tableDnD.currentTable){return jQuery.tableDnD.serializeTable(jQuery.tableDnD.currentTable)}else{return"Error: No Table id set, you need to set an id on your table and every row"}},serializeTable:function(d){var a="";var c=d.id;var e=d.rows;for(var b=0;b<e.length;b++){if(a.length>0){a+="&"}var f=e[b].id;if(f&&f&&d.tableDnDConfig&&d.tableDnDConfig.serializeRegexp){f=f.match(d.tableDnDConfig.serializeRegexp)[0]}a+=c+"[]="+f}return a},serializeTables:function(){var a="";this.each(function(){a+=jQuery.tableDnD.serializeTable(this)});return a}};jQuery.fn.extend({tableDnD:jQuery.tableDnD.build,tableDnDUpdate:jQuery.tableDnD.updateTables,tableDnDSerialize:jQuery.tableDnD.serializeTables});